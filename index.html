<html>
<head>
<script>
  const has = Object.prototype.hasOwnProperty;


  let data;
  let tagDict;
  fetch("/all")
  .then(res => res.json())
  .then(d => data = d)
  .then(() => {

    tagDict = {};
    data.forEach((datum) => {
      datum.advise.forEach((val) => {
        if (!Array.isArray(val.tags))
          val.tags = [val.tags]

        val.tags.forEach((tag) => {
          if (has.call(tagDict, tag)) {
            tagDict[tag] += 1;
          } else {
            tagDict[tag] = 1;
          }
        });

        let sortedTags = Object.keys(tagDict).sort();

        let baseDiv = document.getElementById("results");
        baseDiv.innerHTML = "";

        sortedTags.forEach((tag) => {
          let div = document.createElement("div");
          div.textContent = tag + ': ' + tagDict[tag];

          baseDiv.appendChild(div);
        });
      });
    });

  })



  let search = (tag) => {
    let baseDiv = document.getElementById("results");
    baseDiv.innerHTML = "";

    data.forEach((datum) => {
      datum.advise.forEach((val) => {
        if (!Array.isArray(val.tags))
          val.tags = [val.tags]

        if (val.tags.indexOf(tag) != -1){
          let div = document.createElement("div");
          let b = document.createElement("b");
          div.textContent = val.quote;

          baseDiv.appendChild(div);
        }
      });
    });

  }
</script>

<div id="tags"/>

<input onchange="search(this.value)"/>

<div id="results"/>

</head>
<body>
</body>
</html>
